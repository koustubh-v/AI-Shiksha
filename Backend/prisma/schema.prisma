generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
  SUPER_ADMIN
  FRANCHISE_ADMIN
}

model Franchise {
  id              String   @id @default(uuid())
  name            String
  lms_name        String?
  domain          String   @unique
  logo_url        String?
  primary_color   String?  @default("#6366f1")
  support_email   String?
  is_active       Boolean  @default(true)
  domain_verified Boolean  @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  users        User[]
  courses      Course[]
  enrollments  Enrollment[]
  payments     Payment[]
  certificates Certificate[]

  @@map("franchises")
}

model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  password_hash String
  role          Role     @default(STUDENT)
  avatar_url    String?
  bio           String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  xp            Int      @default(0)

  // Multi-tenant franchise
  franchise_id String?
  franchise    Franchise? @relation(fields: [franchise_id], references: [id])

  instructor_profile InstructorProfile?
  enrollments        Enrollment[]
  payments           Payment[]
  lesson_progress    LessonProgress[]
  course_progress    CourseProgress[]
  reviews            Review[]
  certificates       Certificate[]
  ai_conversations   AIConversation[]
  approved_courses   Course[]           @relation("ApprovedCourses") // Courses this admin approved
  cart_items         CartItem[] // Shopping cart

  // Course Builder relations
  quiz_submissions              QuizSubmission[]
  assignment_submissions        AssignmentSubmission[]
  graded_assignments            AssignmentSubmission[] @relation("GradedAssignments")
  created_certificate_templates CertificateTemplate[]  @relation("CreatedCertificateTemplates")

  // Refresh token rotation
  refresh_token_hash String?

  // Student Dashboard Features
  weekly_goal_hours     Int                   @default(0)
  weekly_minutes_spent  Int                   @default(0)
  milestones            Milestone[]
  sectionItemProgresses SectionItemProgress[]

  @@map("users")
}

model Milestone {
  id          String    @id @default(uuid())
  student_id  String
  student     User      @relation(fields: [student_id], references: [id], onDelete: Cascade)
  title       String
  target_date DateTime?
  completed   Boolean   @default(false)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  @@map("milestones")
}

model InstructorProfile {
  id             String  @id @default(uuid())
  user_id        String  @unique
  user           User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  headline       String?
  description    String?
  rating         Float   @default(0)
  verified       Boolean @default(false)
  total_students Int     @default(0)
  total_courses  Int     @default(0)

  courses Course[]
  payouts VendorPayout[]

  @@map("instructor_profiles")
}

model Course {
  id            String            @id @default(uuid())
  instructor_id String
  instructor    InstructorProfile @relation(fields: [instructor_id], references: [id])

  // Basic Info
  title           String
  subtitle        String?
  slug            String  @unique
  description     String? @db.Text
  thumbnail_url   String?
  intro_video_url String?

  // Course Details
  price             Float   @default(0)
  level             String? // Beginner, Intermediate, Advanced
  language          String? @default("English")
  learning_outcomes Json? // Array of learning outcomes

  // Multi-tenant franchise
  franchise_id String?
  franchise    Franchise? @relation(fields: [franchise_id], references: [id])

  // Approval Workflow
  status                    String    @default("DRAFT") // DRAFT, PENDING_APPROVAL, PUBLISHED, REJECTED
  submitted_for_approval_at DateTime?
  approved_by               String?
  approved_at               DateTime?
  rejection_reason          String?   @db.Text
  approver                  User?     @relation("ApprovedCourses", fields: [approved_by], references: [id])

  // Pricing & Monetization
  is_free             Boolean @default(false)
  original_price      Float? // For showing discounts
  discount_percentage Int? // 0-100
  drip_enabled        Boolean @default(false)

  // Access Control
  is_private   Boolean @default(false)
  password     String? // For password-protected courses
  max_students Int? // Enrollment limit

  // Category relationship
  category_id String?
  category    Category? @relation(fields: [category_id], references: [id])

  // Certificate settings
  certificate_enabled     Boolean @default(false)
  certificate_template_id String?
  certificate_title       String?
  certificate_description String?
  course_features         Json? // Customizable features: downloadable_resources, lifetime_access, mobile_access, etc.

  // New Fields for Time Bound Access & Certificate
  access_days_limit  Int? // Null = Lifetime access. Value = Days of access.
  estimated_duration Int? // Estimated time to complete in minutes (for certificate)

  // SEO Settings
  meta_title       String?
  meta_description String? @db.Text
  meta_keywords    String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  certificate_template CertificateTemplate? @relation("CourseCertificateTemplate", fields: [certificate_template_id], references: [id], onDelete: SetNull)
  sections             CourseSection[] // New: replaces modules
  modules              Module[] // Keep for backward compatibility
  enrollments          Enrollment[]
  payments             Payment[]
  reviews              Review[]
  certificates         Certificate[]
  course_progress      CourseProgress[]
  ai_conversations     AIConversation[]
  tags                 CourseTag[]
  prerequisites        CoursePrerequisite[] @relation("CoursePrerequisites")
  prerequisite_for     CoursePrerequisite[] @relation("PrerequisiteFor")
  cart_items           CartItem[] // Shopping cart

  @@map("courses")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  courses Course[]

  @@map("categories")
}

model Tag {
  id         String   @id @default(uuid())
  name       String   @unique
  slug       String   @unique
  created_at DateTime @default(now())

  courses CourseTag[]

  @@map("tags")
}

model CourseTag {
  course_id String
  course    Course @relation(fields: [course_id], references: [id], onDelete: Cascade)
  tag_id    String
  tag       Tag    @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@id([course_id, tag_id])
  @@map("course_tags")
}

model Module {
  id         String   @id @default(uuid())
  course_id  String
  course     Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  title      String
  position   Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  lessons Lesson[]

  @@map("modules")
}

model Lesson {
  id               String   @id @default(uuid())
  module_id        String
  module           Module   @relation(fields: [module_id], references: [id], onDelete: Cascade)
  title            String
  video_url        String?
  content          String? // SQLite doesn't support Json well, treat as string
  duration_seconds Int      @default(0)
  position         Int
  is_preview       Boolean  @default(false)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  progress         LessonProgress[]
  embeddings       LessonEmbedding[]
  ai_conversations AIConversation[]

  @@map("lessons")
}

model Enrollment {
  id                  String    @id @default(uuid())
  student_id          String
  user                User      @relation(fields: [student_id], references: [id], onDelete: Cascade)
  course_id           String
  course              Course    @relation(fields: [course_id], references: [id], onDelete: Cascade)
  payment_id          String?   @unique
  status              String    @default("active") // active, completed, cancelled
  enrolled_at         DateTime  @default(now())
  progress_percentage Int       @default(0) // 0-100
  completed_at        DateTime? // When the course was completed
  last_activity_at    DateTime? // Last time the student accessed the course
  terms_accepted      Boolean   @default(false)
  terms_accepted_at   DateTime?

  expires_at          DateTime? // When the enrollment expires (if course is time-bound)
  total_learning_time Int       @default(0) // Actual time spent in minutes

  // Multi-tenant franchise
  franchise_id String?
  franchise    Franchise? @relation(fields: [franchise_id], references: [id])

  @@unique([student_id, course_id])
  @@map("enrollments")
}

model Payment {
  id               String  @id @default(uuid())
  user_id          String
  user             User    @relation(fields: [user_id], references: [id])
  course_id        String
  course           Course  @relation(fields: [course_id], references: [id])
  amount           Float
  payment_provider String // stripe
  payment_status   String // pending, completed, failed, refunded
  transaction_id   String?

  // Multi-tenant franchise
  franchise_id String?
  franchise    Franchise? @relation(fields: [franchise_id], references: [id])
  created_at   DateTime   @default(now())

  @@map("payments")
}

model VendorPayout {
  id            String            @id @default(uuid())
  instructor_id String
  instructor    InstructorProfile @relation(fields: [instructor_id], references: [id])
  amount        Float
  status        String // pending, paid, failed
  period_start  DateTime
  period_end    DateTime
  created_at    DateTime          @default(now())

  @@map("vendor_payouts")
}

model LessonProgress {
  id              String    @id @default(uuid())
  student_id      String
  user            User      @relation(fields: [student_id], references: [id], onDelete: Cascade)
  lesson_id       String
  lesson          Lesson    @relation(fields: [lesson_id], references: [id], onDelete: Cascade)
  watched_seconds Int       @default(0)
  completed       Boolean   @default(false)
  completed_at    DateTime?
  updated_at      DateTime  @updatedAt

  @@unique([student_id, lesson_id])
  @@map("lesson_progress")
}

model CourseProgress {
  id                    String   @id @default(uuid())
  student_id            String
  user                  User     @relation(fields: [student_id], references: [id], onDelete: Cascade)
  course_id             String
  course                Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  progress_percentage   Float    @default(0)
  completed             Boolean  @default(false)
  last_accessed_at      DateTime @default(now())
  last_accessed_item_id String?
  updated_at            DateTime @updatedAt

  @@unique([student_id, course_id])
  @@map("course_progress")
}

model Review {
  id         String   @id @default(uuid())
  student_id String
  user       User     @relation(fields: [student_id], references: [id], onDelete: Cascade)
  course_id  String
  course     Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  rating     Int
  comment    String?
  created_at DateTime @default(now())

  @@unique([student_id, course_id])
  @@map("reviews")
}

model Certificate {
  id                 String   @id @default(uuid())
  student_id         String
  user               User     @relation(fields: [student_id], references: [id], onDelete: Cascade)
  course_id          String
  course             Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  certificate_url    String
  issued_at          DateTime @default(now())
  certificate_number String   @unique // Human-readable certificate number (e.g., CERT-2024-001234)
  qr_validation_url  String? // Full validation URL for QR code
  verification_hash  String? // Optional: Additional security hash

  // Multi-tenant franchise
  franchise_id String?
  franchise    Franchise? @relation(fields: [franchise_id], references: [id])

  @@unique([student_id, course_id])
  @@map("certificates")
}

model CartItem {
  id         String   @id @default(uuid())
  user_id    String
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  course_id  String
  course     Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())

  @@unique([user_id, course_id])
  @@map("cart_items")
}

model CertificateTemplate {
  id                String   @id @default(uuid())
  name              String
  description       String?
  is_default        Boolean  @default(false)
  template_config   Json // Stores template design configuration
  preview_image_url String?
  created_by        String?
  creator           User?    @relation("CreatedCertificateTemplates", fields: [created_by], references: [id], onDelete: SetNull)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  courses Course[] @relation("CourseCertificateTemplate")

  @@map("certificate_templates")
}

// AI System
model AIConversation {
  id         String   @id @default(uuid())
  user_id    String
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  lesson_id  String?
  lesson     Lesson?  @relation(fields: [lesson_id], references: [id])
  course_id  String?
  course     Course?  @relation(fields: [course_id], references: [id])
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  messages AIMessage[]

  @@map("ai_conversations")
}

model AIMessage {
  id              String         @id @default(uuid())
  conversation_id String
  conversation    AIConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  role            String // user, assistant
  content         String
  created_at      DateTime       @default(now())

  @@map("ai_messages")
}

model LessonEmbedding {
  id            String   @id @default(uuid())
  lesson_id     String
  lesson        Lesson   @relation(fields: [lesson_id], references: [id], onDelete: Cascade)
  content_chunk String
  embedding     String? // Store as JSON string or ignored for SQLite
  created_at    DateTime @default(now())

  @@map("lesson_embeddings")
}

// ============================================
// COURSE BUILDER MODELS
// ============================================

model CourseSection {
  id        String @id @default(uuid())
  course_id String
  course    Course @relation(fields: [course_id], references: [id], onDelete: Cascade)

  title        String
  description  String? @db.Text
  order_index  Int // For ordering sections
  is_collapsed Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  items SectionItem[]

  @@map("course_sections")
}

// Unified table for lectures, quizzes, assignments, resources
model SectionItem {
  id         String        @id @default(uuid())
  section_id String
  section    CourseSection @relation(fields: [section_id], references: [id], onDelete: Cascade)

  type             String // LECTURE, QUIZ, ASSIGNMENT, RESOURCE
  title            String
  slug             String? // SEO-friendly URL slug, optional for backwards compatibility
  description      String? @db.Text
  order_index      Int
  duration_minutes Int? // Estimated time to complete
  is_preview       Boolean @default(false) // Preview available without enrollment
  is_mandatory     Boolean @default(true) // Required for course completion

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  lecture_content LectureContent?

  // Quiz Relation (Refactored)
  quiz_id String?
  quiz    Quiz?   @relation(fields: [quiz_id], references: [id])

  assignment            Assignment?
  sectionItemProgresses SectionItemProgress[]

  @@unique([section_id, slug]) // Slug must be unique within a section
  @@map("section_items")
}

model LectureContent {
  id      String      @id @default(uuid())
  item_id String      @unique
  item    SectionItem @relation(fields: [item_id], references: [id], onDelete: Cascade)

  content_type String // VIDEO, TEXT, FILE, LINK

  // Video content
  video_url      String?
  video_provider String? // UPLOAD, YOUTUBE, VIMEO
  subtitles_url  String?
  transcript     String? @db.Text

  // Text content
  text_content String? @db.Text // Rich text JSON

  // File content
  file_url  String?
  file_type String? // PDF, ZIP, PPT, etc
  file_size Int? // in bytes
  pdf_url   String? // Specific for Flipbook display

  // External link
  external_link String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("lecture_contents")
}

model Quiz {
  id          String  @id @default(uuid())
  title       String
  description String? @db.Text

  // Settings
  passing_score       Int     @default(75) // Percentage (User requirement: 75%)
  time_limit_minutes  Int? // Optional time limit
  attempts_allowed    Int     @default(3) // User requirement: 3 attempts
  randomize_questions Boolean @default(false)
  show_answers        Boolean @default(true) // Show correct answers after submission
  auto_grade          Boolean @default(true)

  // Set Logic
  total_sets        Int @default(1)
  questions_per_set Int @default(10)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  questions     QuizQuestion[]
  submissions   QuizSubmission[]
  section_items SectionItem[]

  @@map("quizzes")
}

model QuizQuestion {
  id      String @id @default(uuid())
  quiz_id String
  quiz    Quiz   @relation(fields: [quiz_id], references: [id], onDelete: Cascade)

  type               String // MCQ, MULTIPLE, TRUE_FALSE, FILL_BLANK, DESCRIPTIVE, CODE
  question_text      String  @db.Text
  question_image_url String?
  points             Int     @default(1)
  order_index        Int

  set_number Int @default(1) // Which set this question belongs to

  // JSON arrays for options and answers
  options         String? @db.Text // JSON array ["Option A", "Option B", ...]
  correct_answers String? @db.Text // JSON array [0, 2] or ["answer1", "answer2"]

  explanation   String? @db.Text
  code_template String? @db.Text // For CODE type questions

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("quiz_questions")
}

model QuizSubmission {
  id         String @id @default(uuid())
  quiz_id    String
  quiz       Quiz   @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  student_id String
  student    User   @relation(fields: [student_id], references: [id], onDelete: Cascade)

  answers            String  @db.Text // JSON: {questionId: answer}
  score              Int? // Percentage
  passed             Boolean @default(false)
  time_taken_minutes Int?

  submitted_at DateTime @default(now())

  @@map("quiz_submissions")
}

model Assignment {
  id      String      @id @default(uuid())
  item_id String      @unique
  item    SectionItem @relation(fields: [item_id], references: [id], onDelete: Cascade)

  submission_type    String // FILE, CODE, TEXT
  max_file_size_mb   Int     @default(10)
  allowed_file_types String? // JSON array ["pdf", "docx"]

  rubric             String? @db.Text // JSON rubric data
  enable_peer_review Boolean @default(false)

  deadline                DateTime?
  late_penalty_percentage Int       @default(0)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  submissions AssignmentSubmission[]

  @@map("assignments")
}

model AssignmentSubmission {
  id            String     @id @default(uuid())
  assignment_id String
  assignment    Assignment @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
  student_id    String
  student       User       @relation(fields: [student_id], references: [id], onDelete: Cascade)

  submission_url  String? // File URL
  code_submission String? @db.Text
  text_submission String? @db.Text

  grade     Int? // 0-100
  feedback  String?   @db.Text
  graded_by String?
  grader    User?     @relation("GradedAssignments", fields: [graded_by], references: [id])
  graded_at DateTime?

  submitted_at DateTime @default(now())

  @@map("assignment_submissions")
}

model CoursePrerequisite {
  id                     String @id @default(uuid())
  course_id              String
  course                 Course @relation("CoursePrerequisites", fields: [course_id], references: [id], onDelete: Cascade)
  prerequisite_course_id String
  prerequisite_course    Course @relation("PrerequisiteFor", fields: [prerequisite_course_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())

  @@unique([course_id, prerequisite_course_id])
  @@map("course_prerequisites")
}

model SystemSetting {
  key         String   @id
  value       String   @db.Text
  description String?
  updated_at  DateTime @updatedAt

  @@map("system_settings")
}

model SectionItemProgress {
  id           String      @id @default(uuid())
  student_id   String
  user         User        @relation(fields: [student_id], references: [id], onDelete: Cascade)
  item_id      String
  item         SectionItem @relation(fields: [item_id], references: [id], onDelete: Cascade)
  completed    Boolean     @default(false)
  completed_at DateTime?
  updated_at   DateTime    @updatedAt

  @@unique([student_id, item_id])
  @@map("section_item_progress")
}
